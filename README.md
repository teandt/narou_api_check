# なろうAPIデータ取得＆タイトル長とかグラフ化するツール
なろうAPIから全データを取得してJSONファイルに出力します。  
出力したJSONファイルをDBにインポートして各年のランキング上位のタイトル長平均をグラフ化したり、タイトル長のヒストグラムを出したりします  
出力する情報についての例についてはこちらを参照してください  
https://teandt.hatenablog.com/entry/2025/02/09/193323

# インストール
環境構築はvenvを想定しています。  
確認している実行環境は以下です。  
```
Description:    Ubuntu 24.04.3 LTS
Release:        24.04
Python 3.12.3
```

実行環境の作成
```bash
$ python3 -m venv venv
$ source venv/bin/activate
$ python3 -m pip install -r requirements
$ docker compose pull
```
また、.envでDBの設定をまとめていますので作成してください。  
.env.exampleに必要な情報をまとめていますので、必要に応じて編集して.envにファイル名を変更してください。  
環境構築後の実行は以下を行ったあとに実施します。
```bash
$ source venv/bin/activate
$ docker compose up
```
 
 # 実行
 本ツールは3段階の処理に分けています。  
 1. なろうAPIから全情報を取得してJSONファイルに出力する
 2. JSONファイルをDBに登録する
 3. DBを使ってタイトル長とかをグラフ化するメイン処理

## 1. なろうAPIから全情報を取得してJSONファイルに出力する
narou_api_main.pyを使用します。  
出力されるJSONファイルはtemp.jsonとして出力されます。  
出力ファイルは-oオプションで指定出来ます。  
以下を実行すると処理が行われます。
```bash
$ python3 narou_api_main.py
```
本処理はなろうAPIからちょっとずつデータを取得していくためかなり時間がかかります。  
2時間くらいを想定しておくと良いですが、応答が遅くなるケースがありますので更に掛かる可能性があります。  
出力されるtemp.jsonのファイルサイズは2025/09月の実績で1.75GB程度でした。  
余裕を持ったメモリとストレージを確保してください。  
差分を見ると2GBちょっとくらいだったので、メモリは4GBくらいあればおそらく可能だと思います。

## 2. JSONファイルをDBに登録する
narou_json2db.pyを使用します。  
dockerで作成したMysqlに作成したjsonファイルの内容をDBに登録します。  
入力ファイルは-iオプションで指定出来ます。  
現時点では複数回の登録に対応していないため、再登録が必要な場合はコンテナのストレージを削除してから再実行するなどの対応をしてください。  
以下を実行すると処理が行われます。
```bash
$ python3 narou_json2db.py
```
本処理はtemp.jsonのデータを読み込みDBに登録する関係上、それなりにメモリを必要とします。  
余裕を持ったメモリを確保してください。  
こちらも使用できるメモリが4GBあればおそらく問題ないと思います。

## 3. DBを使ってタイトル長とかをグラフ化するメイン処理
本ツールのメイン処理。  
narou_main.pyを使用します。  
DBに登録したデータを使用して、各種統計情報をグラフとして出力します。

### 使い方
```bash
$ python3 narou_main.py [オプション]
```

### オプション
* `-lm START_YEAR END_YEAR LIMIT_COUNT`
  * 指定された開始年から終了年までの各年で、総合ポイント上位 `LIMIT_COUNT` 件の小説を対象とし、タイトル長の平均値を算出してグラフ化します。
  * 例: `python3 narou_main.py -lm 2020 2024 100`

* `-lh YEAR LIMIT_COUNT`
  * 指定された年の総合ポイント上位 `LIMIT_COUNT` 件の小説を対象とし、タイトル長のヒストグラム（分布図）を生成します。
  * 例: `python3 narou_main.py -lh 2024 100`

* `-nt START_YEAR END_YEAR`
  * 指定された開始年から終了年までの各年における、連載作品と短編作品の投稿数を集計し、グラフ化します。
  * 例: `python3 narou_main.py -nt 2015 2024`

生成されたグラフ画像は、`img` ディレクトリ配下に保存されます。  
以下のように実行します。
```bash
$ python3 narou_main.py -lm 2015 2024 100
```
